<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASVARIUS Kernel - Dino Run Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #111;
            padding: 10px 20px;
            border-bottom: 2px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
        }

        .btn:hover {
            background: #00ff00;
            color: #000;
        }

        .btn:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
        }

        .emulator-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            position: relative;
        }

        #screen, #screen_container {
            border: 2px solid #00ff00;
            background: #000;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            width: 720px;
            height: 480px;
        }

        #screen_container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }

        .loading-spinner {
            border: 3px solid #333;
            border-top: 3px solid #00ff00;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-panel {
            background: #111;
            border-top: 2px solid #00ff00;
            padding: 10px 20px;
            height: 120px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.4;
        }

        .status {
            color: #ffff00;
            margin-bottom: 5px;
        }

        .error {
            color: #ff0000;
        }

        .success {
            color: #00ff00;
        }

        .instructions {
            margin-top: 10px;
            color: #888;
        }

        .ascii-art {
            font-size: 8px;
            line-height: 1;
            color: #00ff00;
            margin-bottom: 10px;
            white-space: pre;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .controls {
                flex-wrap: wrap;
            }
            
            #screen, #screen_container {
                max-width: 100%;
                max-height: calc(100vh - 200px);
                width: auto;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">ü¶ï Dino Run Game</div>
            <div class="controls">
                <button class="btn" id="startBtn" onclick="startEmulator()" disabled>Carregando...</button>
                <button class="btn" onclick="resetEmulator()">Reset</button>
                <button class="btn" onclick="downloadKernel()">Download Kernel</button>
                <button class="btn" onclick="toggleFullscreen()">Tela Cheia</button>
                <button class="btn" onclick="window.location.href='pcjs.html'">PCjs (ISO)</button>
            </div>
        </div>

        <div class="emulator-container">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div>Carregando emulador v86...</div>
                <div class="ascii-art">
        .                 .           
     dP       Dino Run     9b        
     dX     jogue agora!     Xb      
    __                         __    
  dXXXXbo.                 .odXXXXb d
 XXXXXXXXOo.           .oOXXXXXXXXVXX
 XX'~   ~'OOO8b   d8OOO'~   ~'XXXXXXX
 9XX'          '98v8P'          'XXP'
  9X.          .db|db.          .XP
    )b.  .dbo.dP''v''9b.odb.  .dX(
,dXXXXXXXXXXXb     dXXXXXXXXXXXb.
dXXXXXXXXXXXP'   .   '9XXXXXXXXXXXb
dXXXXXXXXXXXXb   d|b   dXXXXXXXXXXXXb
9XXb'   'XXXXXb.dX|Xb.dXXXXX'   'dXXP
''      9XXXXXX(   )XXXXXXP      ''
         XXXX X.'v'.X XXXX
         XP^X''b   d''X^XX 
         X. 9  ''   '  P )X
         'b  '       '  d'
          '             '
                </div>
                <div id="loadingText">Aguarde enquanto carregamos o emulador...</div>
            </div>
            <div id="screen_container" style="display: none;"></div>
            <canvas id="screen" width="720" height="480" style="display: none;"></canvas>
        </div>

        <div class="info-panel">
            <div class="status">Status: Inicializando emulador...</div>
            <div id="log">
                <div class="instructions">
                    <strong>Controles do Jogo:</strong><br>
                    ‚Ä¢ ESPA√áO: Pular<br>
                    ‚Ä¢ ESC: Sair do jogo<br>
                    ‚Ä¢ F11: Tela cheia (recomendado)<br>
                    <br>
                    <strong>Atalhos da P√°gina:</strong><br>
                    ‚Ä¢ F1: Iniciar emulador ‚Ä¢ F5: Reset ‚Ä¢ F11: Tela cheia
                </div>
            </div>
        </div>
    </div>

    <!-- v86 Emulator - Sistema robusto de carregamento -->
    <script>
        // Vari√°veis globais
        let emulator = null;
        let isKernelLoaded = false;
        let v86LoadAttempts = 0;
        let maxLoadAttempts = 4;
        let isV86Available = false;

        // Configura√ß√£o do emulador v86
        const emulatorConfig = {
            screen_container: document.getElementById("screen_container"),
            bios: {
                url: "https://github.com/copy/v86/raw/master/bios/seabios.bin",
            },
            vga_bios: {
                url: "https://github.com/copy/v86/raw/master/bios/vgabios.bin",
            },
            wasm_path: "https://cdn.jsdelivr.net/npm/v86@10.0.8/build/v86.wasm",
            memory_size: 32 * 1024 * 1024, // 32MB
            vga_memory_size: 2 * 1024 * 1024, // 2MB
            boot_order: 0x132,
            autostart: false,
        };

        function log(message, type = 'status') {
            const logDiv = document.getElementById('log');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Limita o n√∫mero de logs para n√£o sobrecarregar
            const logs = logDiv.children;
            if (logs.length > 20) {
                logDiv.removeChild(logs[0]);
            }
        }

        function updateLoadingText(text) {
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }

        function loadV86Robustly() {
            // URLs de v86 em ordem de prioridade
            const v86URLs = [
                'https://cdn.jsdelivr.net/npm/v86@10.0.8/build/libv86.js',
                'https://unpkg.com/v86@10.0.8/build/libv86.js', 
                'https://cdn.jsdelivr.net/npm/v86@9.0.3/build/libv86.js',
                'https://raw.githubusercontent.com/copy/v86/master/build/libv86.js'
            ];

            if (v86LoadAttempts >= maxLoadAttempts) {
                log('‚ùå Todas as tentativas de carregar v86 falharam', 'error');
                showV86Fallback();
                return;
            }

            const currentURL = v86URLs[v86LoadAttempts];
            log(`üîÑ Tentativa ${v86LoadAttempts + 1}/${maxLoadAttempts}: Carregando v86...`, 'status');
            updateLoadingText(`Carregando v86... (tentativa ${v86LoadAttempts + 1})`);

            const script = document.createElement('script');
            script.src = currentURL;
            script.async = true;

            const timeout = setTimeout(() => {
                log('‚è∞ Timeout no carregamento do v86', 'error');
                v86LoadAttempts++;
                script.remove();
                setTimeout(loadV86Robustly, 1000);
            }, 20000); // 20 segundos timeout

            script.onload = () => {
                clearTimeout(timeout);
                log('‚úì Script v86 carregado com sucesso', 'success');
                
                // Aguarda V86Starter ficar dispon√≠vel
                checkV86StarterAvailability();
            };

            script.onerror = () => {
                clearTimeout(timeout);
                log(`‚ùå Erro ao carregar: ${currentURL}`, 'error');
                v86LoadAttempts++;
                setTimeout(loadV86Robustly, 2000);
            };

            document.head.appendChild(script);
        }

        function checkV86StarterAvailability() {
            let attempts = 0;
            const maxAttempts = 40; // 20 segundos m√°ximo

            const checkInterval = setInterval(() => {
                attempts++;
                
                if (typeof window.V86Starter !== 'undefined') {
                    clearInterval(checkInterval);
                    log('‚úì V86Starter dispon√≠vel!', 'success');
                    isV86Available = true;
                    initializeInterface();
                    return;
                }

                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    log('‚ùå Timeout: V86Starter n√£o ficou dispon√≠vel', 'error');
                    v86LoadAttempts++;
                    if (v86LoadAttempts < maxLoadAttempts) {
                        setTimeout(loadV86Robustly, 2000);
                    } else {
                        showV86Fallback();
                    }
                    return;
                }

                if (attempts % 4 === 0) {
                    updateLoadingText(`Aguardando V86Starter... (${Math.round(attempts/2)}s)`);
                }
            }, 500);
        }

        function initializeInterface() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'Iniciar Kernel';
            log('üéÆ Emulador pronto! Clique em "Iniciar Kernel" para come√ßar', 'success');
        }

        function showV86Fallback() {
            const loading = document.getElementById('loading');
            loading.innerHTML = `
                <div style="text-align: center; color: #ff6b6b; max-width: 500px;">
                    <h3>‚ùå N√£o foi poss√≠vel carregar o emulador v86</h3>
                    <p style="margin: 15px 0;">Isso pode acontecer devido a:</p>
                    <ul style="text-align: left; margin: 15px 0;">
                        <li>Problemas de conectividade</li>
                        <li>Bloqueadores de an√∫ncios/scripts</li>
                        <li>CDNs temporariamente indispon√≠veis</li>
                    </ul>
                    <div style="margin: 20px 0;">
                        <button class="btn" onclick="location.reload()">üîÑ Recarregar P√°gina</button>
                        <button class="btn" onclick="window.open('https://github.com/ianpsa/Dino-run-kernel', '_blank')">üì• Ver no GitHub</button>
                        <button class="btn" onclick="window.location.href='pcjs.html'">üñ•Ô∏è Abrir via PCjs (ISO)</button>
                    </div>
                    <div style="font-size: 11px; color: #888; margin-top: 20px; text-align: left;">
                        <strong>Executar localmente:</strong><br>
                        <code style="background: #333; padding: 5px; display: block; margin: 5px 0;">
                        git clone https://github.com/ianpsa/Dino-run-kernel.git<br>
                        cd Dino-run-kernel<br>
                        make && make run
                        </code>
                    </div>
                </div>
            `;
        }

        async function downloadKernel() {
            try {
                log('üì• Baixando kernel do reposit√≥rio...', 'status');
                
                const response = await fetch('https://raw.githubusercontent.com/ianpsa/Dino-run-kernel/main/kernel');
                
                if (!response.ok) {
                    throw new Error('Kernel n√£o encontrado no reposit√≥rio');
                }
                
                const kernelData = await response.arrayBuffer();
                log(`‚úì Kernel baixado (${kernelData.byteLength} bytes)`, 'success');
                
                return kernelData;
            } catch (error) {
                log(`‚ùå Erro ao baixar kernel: ${error.message}`, 'error');
                log('üí° O kernel precisa ser compilado primeiro no reposit√≥rio', 'status');
                throw error;
            }
        }

        async function startEmulator() {
            if (!isV86Available) {
                log('‚ùå v86 n√£o est√° dispon√≠vel', 'error');
                return;
            }

            if (isKernelLoaded && emulator) {
                log('‚ö° Reiniciando kernel...', 'status');
                emulator.restart();
                return;
            }

            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('screen_container').style.display = 'none';
                updateLoadingText('Iniciando emulador...');
                
                log('üöÄ Iniciando emulador v86...', 'status');
                
                // Baixa o kernel
                const kernelData = await downloadKernel();
                
                // Configura o emulador com o kernel
                const config = {
                    ...emulatorConfig,
                    screen_container: document.getElementById("screen_container"),
                    multiboot: {
                        buffer: kernelData,
                    },
                    autostart: true, // Automatically start the emulator
                };
                
                log('‚öôÔ∏è Inicializando emulador...', 'status');
                updateLoadingText('Configurando emulador...');
                
                // Cria o emulador
                emulator = new V86Starter(config);
                
                emulator.add_listener("emulator-ready", function() {
                    log('‚úì Emulador inicializado!', 'success');
                    log('ü¶ï ASVARIUS Kernel rodando!', 'success');
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('screen_container').style.display = 'block';
                    document.getElementById('screen').style.display = 'none'; // Hide canvas, use screen_container
                    isKernelLoaded = true;
                });

                emulator.add_listener("emulator-stopped", function() {
                    log('‚èπÔ∏è Emulador parado', 'status');
                    isKernelLoaded = false;
                });

                log('‚ñ∂Ô∏è Emulador configurado com autostart', 'success');

            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
                document.getElementById('loading').style.display = 'none';
                
                log('üìã Para executar localmente:', 'status');
                log('‚Ä¢ git clone https://github.com/ianpsa/Dino-run-kernel.git', 'status');
                log('‚Ä¢ make && make run', 'status');
            }
        }

        function resetEmulator() {
            if (emulator) {
                log('üîÑ Resetando emulador...', 'status');
                emulator.restart();
            } else {
                log('‚ö†Ô∏è Emulador n√£o est√° rodando', 'status');
            }
        }

        function toggleFullscreen() {
            const screenContainer = document.getElementById('screen_container');
            if (document.fullscreenElement) {
                document.exitFullscreen();
                log('ü™ü Saindo de tela cheia', 'status');
            } else {
                screenContainer.requestFullscreen().then(() => {
                    log('üñ•Ô∏è Modo tela cheia ativado', 'success');
                }).catch(err => {
                    log(`‚ùå Erro ao entrar em tela cheia: ${err.message}`, 'error');
                });
            }
        }

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F1') {
                e.preventDefault();
                startEmulator();
            } else if (e.key === 'F5') {
                e.preventDefault();
                resetEmulator();
            } else if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
        });

        // Inicializa√ß√£o
        window.addEventListener('load', function() {
            log('üåê P√°gina carregada', 'success');
            log('üì¶ Iniciando carregamento do v86...', 'status');
            
            // Inicia o processo de carregamento do v86
            setTimeout(loadV86Robustly, 500);
        });

        // Prevenir comportamentos que interferem com o emulador
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
    </script>
</body>
</html>
